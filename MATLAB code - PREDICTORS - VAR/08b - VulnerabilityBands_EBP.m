%% Estimate quantile regression coefficients and bootstrap bands
% This script produces charts of estimated quantile regression coefficients
% with bootstrapped confidence bands for the following figure:
% - Figure 4. Estimated Quantile Regression Coefficients.

% From the replication files for:
% Tobias Adrian, Nina Boyarchenko, and Domenico Giannone (2018):
% "Vulnerable Growth," American Economic Review.

%% Clear workspace, set file paths and graphics settings
clear
close all
clc

set(0, 'defaultAxesFontName', 'Times');
set(0, 'DefaultAxesFontSize', 13)
set(0, 'defaultAxesLineStyleOrder', '-|--|:', 'defaultLineLineWidth', 1.5)
setappdata(0, 'defaultAxesXTickFontSize', 1)
setappdata(0, 'defaultAxesYTickFontSize', 1)

% Folder to store figures
FigSubFolder = 'FigInference_EBP';
if ~exist(FigSubFolder, 'dir')
    mkdir(FigSubFolder);
end

%% Load data and fix forecast settings
load('INPUT.mat', 'X', 'Time', 'Mnem')

% Forecast settings
H = [3, 12];          % Horizons to forecast (# of months ahead)
QQ = 0.05:0.05:0.95;  % Quantiles to estimate in quantile regressions

% Construct average growth rates
y = X(:, strcmp(Mnem, 'AOECD_WIP'));
for h = H
    Yh(:, h) = filter(ones(1, h) / h, 1, y);
    Yh(1:(h - 1), h) = NaN;
end

% Bootstrap settings
nDrawsBoot = 1000;  % number of bootstrap replications
nLagsBootVAR = 12;  % number of lags to use in approximating VAR

%% Estimate quantile regressions, generate bootstrapped confidence bands
% Quantile regressions include both OECD+6NME IP and Excess Bond Premium
Res = QRboot(X(:, strcmp(Mnem, 'EBP')), y, H, 1, QQ,...
             nDrawsBoot, nLagsBootVAR);

% Plot results for coefficients on Excess Bond Premium and OECD+6NME IP
for j = 2:3
    % j denotes the column index within the matrix of regressors for the
    % regressor of interest (either Excess Bond Premium or OECD+6NME IP)
    switch j
        case 2
            regressorName = 'EBP';
            ylims = [-5, 1];
        case 3
            regressorName = 'OECDWIP';
            ylims = [-0.2, 1.2];
    end

    for h = H
        BQ  = Res.BQ(j, :, h);
        B2  = Res.B2(j, h);
        bBQ = squeeze(Res.bBQ(j, :, h, :));
        bB2 = squeeze(Res.bB2(j, h, :));
        QQ = Res.QQ;
        filename = fullfile(FigSubFolder, ['OECDWIPv', regressorName, '_coefs_M', num2str(h), '.pdf']);
        PlotQRbands(BQ, bBQ, B2, bB2, QQ,...
                    'ylims', ylims, 'filename', filename);
    end
end

clear
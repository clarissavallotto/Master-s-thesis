%% Plot raw data, create scatterplots for univariate quantile regressions
% This script produces charts for the descriptive analysis presented in the
% following figures:
% - Figure 2. Raw Data.
% - Figure 3. Quantile Regressions.

% The charts are saved in the folder 'FigExploratory_OSS'.

% From the replication files for:
% Tobias Adrian, Nina Boyarchenko, and Domenico Giannone (2018):
% "Vulnerable Growth," American Economic Review.

%% Clear workspace, set file paths and graphics settings
clear
close all
clc

set(0, 'defaultAxesFontName', 'Times');
set(0, 'DefaultAxesFontSize', 13)
set(0, 'defaultAxesLineStyleOrder', '-|--|:', 'defaultLineLineWidth', 1)
setappdata(0, 'defaultAxesXTickFontSize', 1)
setappdata(0, 'defaultAxesYTickFontSize', 1)

% Folder to store figures
FigSubFolder = 'FigExploratory_OSS';
if ~exist(FigSubFolder, 'dir')
    mkdir(FigSubFolder);
end

%% Load data and fix forecast settings
load('INPUT.mat', 'X', 'Time', 'Mnem')

% Forecast settings
H = [3, 12];          % Horizons to forecast (# of months ahead)
QQ = 0.05:0.05:0.95;  % Quantiles to estimate in quantile regressions

% Indices for selected quantiles
[~, jq05] = min(abs(QQ - 0.05));
[~, jq50] = min(abs(QQ - 0.50));
[~, jq95] = min(abs(QQ - 0.95));

% Construct average growth rates
y = X(:, strcmp(Mnem, 'AOECD_WIP'));
for h = H
    Yh(:, h) = filter(ones(1, h) / h, 1, y);
    Yh(1:(h - 1), h) = NaN;
end

%% Figure 2: Raw Data (OECD+6NME IP and Oil Supply Shocks)
f = figure;
ax = gca;

yyaxis left
plot(Time, X(:, strcmp(Mnem, 'AOECD_WIP')))
ax.YColor = 'k';
ylabel('OECD+6NME IP YOY growth');
datetick('x', 'yyyy', 'keeplimits')

yyaxis right
plot(Time, X(:, strcmp(Mnem, 'OSS')), '--')
ax.YColor = 'k';
ylabel('Oil Supply Shocks');

legend('OECD+6NME IP', 'Oil Supply Shocks', 'Location', 'SouthWest')
filename = fullfile(FigSubFolder, 'OECDWIP_OSS.pdf');
printpdf(f, filename);
clear('f', 'filename')

%% Figure 3: Quantile Regressions (univariate)
% y-axis limits for scatter plots (these are horizon-dependent)
ylimsScatter = [
    NaN, NaN;
    NaN, NaN;
    -30,  30;
    NaN, NaN;
    NaN, NaN;
    NaN, NaN;
    NaN, NaN;
    NaN, NaN;
    NaN, NaN;
    NaN, NaN;
    NaN, NaN;
    -30,  30;
];

for h = H
    % OECD+6NME IP on OECD+6NME IP
    Z = [ones(size(y)), y];
    yh = Yh((h + 1):end, h);
    Zh = Z(1:(end - h), :);
    B2 = Zh \ yh;
    Y2 = [ones(h, 1) * NaN; Zh * B2];
    for jq = 1:length(QQ)
        BQ(:, jq) = rq(Zh, yh, QQ(jq));
        YQ(:, jq) = [ones(h, 1) * NaN; Zh * BQ(:, jq)];
    end
    
    f=figure;
    scatter(Zh(:, 2), yh, 50);
    box on
    hold on
    p1 = plot(Zh(:, 2), YQ((h + 1):end, jq05), '-k',...
        Zh(:, 2), YQ((h + 1):end, jq50), '-r',...
        Zh(:, 2), YQ((h + 1):end, jq95), '-g',...
        Zh(:, 2), Y2((h + 1):end), '-b');
    hold off
    axis tight
    ylim(ylimsScatter(h, :))
    legend(p1, 'Q5', 'Q50', 'Q95', 'OLS', 'Location', 'SouthEast');
    if h == 3
        ylabel('OECD+6NME IP growth 3 months ahead')
    else
        ylabel(['OECD+6NME IP growth ', num2str(h), ' months ahead'])
    end
    xlabel('Current month OECD+6NME IP growth')
    filename = fullfile(FigSubFolder, ['OECDWIPvOECDWIP_M', num2str(h), '.pdf']);
    printpdf(f, filename);
    clear('f', 'filename')
    
    % OECD+6NME IP on Oil Supply Shocks
    Z = [ones(size(y)), X(:, strcmp(Mnem, 'OSS'))];
    yh = Yh((h + 1):end, h);
    Zh = Z(1:(end - h), :);
    B2 = Zh \ yh;
    Y2 = [ones(h, 1) * NaN; Zh * B2];
    for jq = 1:length(QQ)
        BQ(:, jq) = rq(Zh, yh, QQ(jq));
        YQ(:, jq) = [ones(h, 1) * NaN; Zh * BQ(:, jq)];
    end
    
    f=figure;
    scatter(Zh(:, 2), yh, 50);
    box on
    hold on
    p1 = plot(Zh(:, 2), YQ((h + 1):end, jq05), '-k',...
        Zh(:, 2), YQ((h + 1):end, jq50), '-r',...
        Zh(:, 2), YQ((h + 1):end, jq95), '-g',...
        Zh(:, 2), Y2((h + 1):end), '-b');
    hold off
    axis tight
    ylim(ylimsScatter(h, :))
    legend(p1, 'Q5', 'Q50', 'Q95', 'OLS', 'Location', 'SouthWest');
    if h == 3
        ylabel('OECD+6NME IP growth 3 months ahead')
    else
        ylabel(['OECD+6NME IP growth ', num2str(h), ' months ahead'])
    end
    xlabel('Oil Supply Shocks')
    filename = fullfile(FigSubFolder, ['OECDWIPvOSS_M', num2str(h), '.pdf']);
    printpdf(f, filename);
    clear('f', 'filename')
end

clear